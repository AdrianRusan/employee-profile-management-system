name: Nightly E2E Tests

on:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  e2e-full:
    name: E2E Full Suite
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    env:
      DATABASE_URL: ${{ secrets.CI_DATABASE_URL }}
      SESSION_SECRET: ${{ secrets.CI_SESSION_SECRET }}
      ENCRYPTION_KEY: ${{ secrets.CI_ENCRYPTION_KEY }}
      NEXT_PUBLIC_APP_URL: http://localhost:3000

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Setup test database
        run: npx prisma db push

      - name: Seed test database
        run: npx prisma db seed
        continue-on-error: true

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run E2E full suite
        run: npm run test:e2e:full
        timeout-minutes: 30

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-full
          path: playwright-report/
          retention-days: 30

      - name: Upload test videos on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-videos
          path: test-results/
          retention-days: 7

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: e2e-full
    if: failure()

    steps:
      - name: Create GitHub issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Nightly E2E Tests Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## Nightly E2E Test Failure

            The nightly E2E test suite has failed.

            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}

            Please investigate the test failures and fix any issues.

            ### Next Steps
            1. Review the test results in the workflow run
            2. Check the uploaded artifacts for detailed failure reports
            3. Fix the failing tests
            4. Close this issue once resolved

            ---
            *This issue was automatically created by the nightly E2E test workflow.*
            `;

            // Check if an issue already exists for today
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['nightly-e2e-failure'],
            });

            const today = new Date().toISOString().split('T')[0];
            const existingIssue = issues.data.find(issue => issue.title.includes(today));

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['nightly-e2e-failure', 'automated'],
              });
            }
